<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text Combiner for Researchers</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.28.0/docxtemplater.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --bg-color: #f0f0f0;
            --text-color: #333;
            --snippet-bg: #fff;
            --border-color: #ccc;
        }
        .dark-mode {
            --bg-color: #333;
            --text-color: #ddd;
            --snippet-bg: #444;
            --border-color: #555;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 20px;
            font-size: 18px;
            display: flex;
            position: relative;
        }
        #dark-mode-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px;
            font-size: 24px;
            cursor: pointer;
        }
        h1 { margin-top: 0; }
        p { color: var(--text-color); margin-bottom: 20px; }
        #preview {
            width: 25%;
            min-width: 200px;
            max-width: 400px;
            resize: horizontal;
            overflow: auto;
            background-color: var(--snippet-bg);
            border-right: 2px solid var(--border-color);
            padding: 10px;
            margin-right: 20px;
        }
        #preview-content {
            white-space: pre-wrap;
            font-size: 16px;
        }
        #main-content {
            flex: 1;
        }
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .snippet {
            background-color: var(--snippet-bg);
            border: 1px solid var(--border-color);
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            opacity: 0;
            animation: fadeIn 0.5s forwards;
            cursor: move;
        }
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        .snippet-header {
            cursor: grab;
        }
        .snippet-content {
            min-height: 80px;
            margin: 10px 0;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            font-size: 16px;
            padding: 5px;
            background-color: var(--snippet-bg);
            color: var(--text-color);
        }
        input, select {
            width: 100%;
            margin: 5px 0;
            padding: 5px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            font-size: 16px;
            background-color: var(--snippet-bg);
            color: var(--text-color);
        }
        .error, .correct {
            font-size: 14px;
            display: none;
        }
        .error { color: #ff5555; }
        .correct { color: #55ff55; }
        button {
            padding: 10px 20px;
            margin: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #0056b3; }
        select {
            padding: 12px;
            font-size: 18px;
            width: 200px;
        }
        .button-group {
            margin: 20px 0;
            padding: 10px;
            border-top: 1px solid var(--border-color);
        }
        .button-group h4 {
            margin: 0 0 10px;
        }
        #output-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #output-content {
            background-color: var(--snippet-bg);
            color: var(--text-color);
            padding: 20px;
            border-radius: 5px;
            width: 80%;
            max-width: 700px;
            text-align: left;
            position: relative;
        }
        #output-text {
            white-space: pre-wrap;
            margin-bottom: 20px;
            font-size: 16px;
            cursor: text;
        }
        #errors-list {
            color: #ff5555;
            font-size: 14px;
            margin-bottom: 10px;
        }
        #copy-message {
            display: none;
            color: #55ff55;
            margin-right: 10px;
            animation: fadeInOut 2s;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; }
        }
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 30px;
            padding: 10px;
        }
        .button-container {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            flex-wrap: nowrap;
        }
        .save-options {
            display: none;
            position: fixed;
            background-color: var(--snippet-bg);
            border: 1px solid var(--border-color);
            padding: 10px;
            border-radius: 5px;
            z-index: 1001;
        }
        .save-options button {
            display: block;
            width: 100%;
            text-align: left;
        }
        #custom-style-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--snippet-bg);
            padding: 20px;
            border-radius: 5px;
            z-index: 1002;
        }
        #request-form {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--snippet-bg);
            padding: 20px;
            border-radius: 5px;
            z-index: 1002;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 5px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .style-toolbar {
            margin-bottom: 10px;
        }
        .dashboard {
            margin-bottom: 20px;
            padding: 10px;
            background-color: var(--snippet-bg);
            border-radius: 5px;
        }
        @media (max-width: 600px) {
            body { flex-direction: column; }
            #preview { width: 100%; resize: none; margin-bottom: 20px; }
            button { width: 100%; }
        }
    </style>
</head>
<body>
    <div id="dark-mode-toggle" onclick="toggleDarkMode()" aria-label="Toggle dark mode">ðŸŒ“</div>
    <div id="preview">
        <h3>Live Preview</h3>
        <div id="preview-content"></div>
    </div>
    <div id="main-content">
        <h1>Text Combiner for Researchers</h1>
        <p id="motivational-tip"></p>
        <div class="dashboard">
            Progress: <span id="progress">0%</span>
        </div>
        <input type="file" id="import-citations" accept=".bib,.ris" aria-label="Import citations">
        <div id="snippets-container" class="grid-container">
            <div class="snippet" draggable="true">
                <h3 class="snippet-header">Text Snippet 1</h3>
                <div class="style-toolbar">
                    <button onclick="applyStyle('bold', 1)" aria-label="Bold text">B</button>
                    <button onclick="applyStyle('italic', 1)" aria-label="Italic text">I</button>
                    <select onchange="applyStyle('fontSize', 1, this.value)" aria-label="Font size">
                        <option value="12px">12px</option>
                        <option value="14px">14px</option>
                        <option value="16px" selected>16px</option>
                    </select>
                    <button onclick="applyTemplate(1)" aria-label="Apply snippet template">Template</button>
                </div>
                <div id="snippet1" class="snippet-content" contenteditable="true" aria-label="Text Snippet 1"></div>
                <span id="word-count1">Words: 0</span>
                <select id="source1" aria-label="Source type for Snippet 1">
                    <option value="book">Book</option>
                    <option value="journal">Journal</option>
                    <option value="website">Website</option>
                </select>
                <div class="tooltip">
                    <input type="text" id="ref1" placeholder="e.g., Smith, J. (2020). Title. Journal." aria-label="Reference for Snippet 1">
                    <span class="tooltiptext" id="ref-tooltip1"></span>
                </div>
                <span id="error1" class="error"></span>
                <span id="correct1" class="correct">Correct</span>
                <input type="date" id="deadline1" aria-label="Deadline for Snippet 1">
            </div>
            <div class="snippet" draggable="true">
                <h3 class="snippet-header">Text Snippet 2</h3>
                <div class="style-toolbar">
                    <button onclick="applyStyle('bold', 2)" aria-label="Bold text">B</button>
                    <button onclick="applyStyle('italic', 2)" aria-label="Italic text">I</button>
                    <select onchange="applyStyle('fontSize', 2, this.value)" aria-label="Font size">
                        <option value="12px">12px</option>
                        <option value="14px">14px</option>
                        <option value="16px" selected>16px</option>
                    </select>
                    <button onclick="applyTemplate(2)" aria-label="Apply snippet template">Template</button>
                </div>
                <div id="snippet2" class="snippet-content" contenteditable="true" aria-label="Text Snippet 2"></div>
                <span id="word-count2">Words: 0</span>
                <select id="source2" aria-label="Source type for Snippet 2">
                    <option value="book">Book</option>
                    <option value="journal">Journal</option>
                    <option value="website">Website</option>
                </select>
                <div class="tooltip">
                    <input type="text" id="ref2" placeholder="e.g., Smith, J. (2020). Title. Journal." aria-label="Reference for Snippet 2">
                    <span class="tooltiptext" id="ref-tooltip2"></span>
                </div>
                <span id="error2" class="error"></span>
                <span id="correct2" class="correct">Correct</span>
                <input type="date" id="deadline2" aria-label="Deadline for Snippet 2">
            </div>
            <div class="snippet" draggable="true">
                <h3 class="snippet-header">Text Snippet 3</h3>
                <div class="style-toolbar">
                    <button onclick="applyStyle('bold', 3)" aria-label="Bold text">B</button>
                    <button onclick="applyStyle('italic', 3)" aria-label="Italic text">I</button>
                    <select onchange="applyStyle('fontSize', 3, this.value)" aria-label="Font size">
                        <option value="12px">12px</option>
                        <option value="14px">14px</option>
                        <option value="16px" selected>16px</option>
                    </select>
                    <button onclick="applyTemplate(3)" aria-label="Apply snippet template">Template</button>
                </div>
                <div id="snippet3" class="snippet-content" contenteditable="true" aria-label="Text Snippet 3"></div>
                <span id="word-count3">Words: 0</span>
                <select id="source3" aria-label="Source type for Snippet 3">
                    <option value="book">Book</option>
                    <option value="journal">Journal</option>
                    <option value="website">Website</option>
                </select>
                <div class="tooltip">
                    <input type="text" id="ref3" placeholder="e.g., Smith, J. (2020). Title. Journal." aria-label="Reference for Snippet 3">
                    <span class="tooltiptext" id="ref-tooltip3"></span>
                </div>
                <span id="error3" class="error"></span>
                <span id="correct3" class="correct">Correct</span>
                <input type="date" id="deadline3" aria-label="Deadline for Snippet 3">
            </div>
        </div>
        <div class="button-group">
            <h4>Input Controls</h4>
            <select id="template" aria-label="Select output template">
                <option value="none">None</option>
                <option value="literature">Literature Review</option>
                <option value="annotated">Annotated Bibliography</option>
                <option value="proposal">Research Proposal</option>
                <option value="abstract">Conference Abstract</option>
                <option value="study">Study Guide</option>
                <option value="essay">Essay Outline</option>
                <option value="grant">Grant Proposal</option>
                <option value="reading">Reading List</option>
                <option value="summary">Summary Report</option>
                <option value="technical">Technical Report</option>
            </select>
            <select id="font" aria-label="Select output font">
                <option value="Arial">Arial</option>
                <option value="Times New Roman">Times New Roman</option>
                <option value="Calibri">Calibri</option>
            </select>
            <select id="citationStyle" onchange="updatePlaceholders()" aria-label="Select citation style">
                <option value="apa">APA</option>
                <option value="mla">MLA</option>
                <option value="chicago">Chicago</option>
                <option value="harvard">Harvard</option>
                <option value="ieee">IEEE</option>
                <option value="ama">AMA</option>
                <option value="vancouver">Vancouver</option>
                <option value="turabian">Turabian</option>
                <option value="oscola">OSCOLA</option>
                <option value="bluebook">Bluebook</option>
                <option value="custom">Custom</option>
            </select>
            <button onclick="combineText()" aria-label="Combine text and generate bibliography">Combine & Generate Bibliography</button>
            <button onclick="clearAll()" aria-label="Clear all snippets">Clear All</button>
        </div>
        <div class="button-group">
            <h4>History</h4>
            <button onclick="undo()" aria-label="Undo last action">Undo</button>
            <button onclick="redo()" aria-label="Redo last action">Redo</button>
            <button onclick="showVersions()" aria-label="View versions">Versions</button>
        </div>
        <div class="button-group">
            <h4>Settings</h4>
            <button onclick="savePreferences()" aria-label="Save preferences">Save Preferences</button>
            <button onclick="showRequestForm()" aria-label="Request a feature">Request Feature</button>
        </div>
        <div id="output-modal" role="dialog" aria-label="Result dialog">
            <div id="output-content">
                <span class="close-btn" onclick="closeModal()" aria-label="Close dialog">Ã—</span>
                <h2>Your Research Synthesis</h2>
                <div id="errors-list"></div>
                <div id="export-preview"></div>
                <div id="output-text" aria-label="Combined text and bibliography"></div>
                <div id="word-count-output">Total Words: 0 (Excluding Citations: 0)</div>
                <div class="button-container">
                    <span id="copy-message">Copied!</span>
                    <button onclick="copyText()" aria-label="Copy to clipboard">Copy to Clipboard</button>
                    <button onclick="toggleSaveOnline()" aria-label="Save online">Save Online</button>
                    <div id="save-online-options" class="save-options">
                        <button onclick="saveToGoogleDrive()">Google Drive</button>
                        <button onclick="saveToDropbox()">Dropbox</button>
                        <button onclick="saveToOneDrive()">OneDrive</button>
                        <button onclick="shareSecurely()">Share Securely</button>
                    </div>
                    <button onclick="toggleSaveLocally()" aria-label="Save locally">Save Locally</button>
                    <div id="save-locally-options" class="save-options">
                        <button onclick="savePDF()">PDF</button>
                        <button onclick="saveDocx()">DOCX</button>
                        <button onclick="saveText()">Text</button>
                        <button onclick="saveMarkdown()">Markdown</button>
                        <button onclick="saveRIS()">RIS</button>
                        <button onclick="saveLatex()">LaTeX</button>
                        <button onclick="saveFlashcards()">Flashcards</button>
                        <button onclick="saveZip()">ZIP</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="custom-style-modal">
            <h3>Define Custom Citation Style</h3>
            <input type="text" id="custom-style-input" placeholder="e.g., {author}, {year}, {title}" aria-label="Custom citation style">
            <button onclick="saveCustomStyle()">Save</button>
            <button onclick="closeCustomStyleModal()">Cancel</button>
        </div>
        <div id="request-form">
            <h3>Request a Feature</h3>
            <textarea id="feature-request" placeholder="Describe your feature idea" aria-label="Feature request"></textarea>
            <button onclick="submitRequest()">Submit</button>
            <button onclick="closeRequestForm()">Cancel</button>
        </div>
    </div>
    <script>
        let snippetCount = 3;
        let history = [];
        let historyIndex = -1;
        let versions = JSON.parse(localStorage.getItem('versions')) || [];
        let preferences = JSON.parse(localStorage.getItem('preferences')) || {};
        let lastSave = getCookie('lastSave') || 'pdf';
        let customStyle = localStorage.getItem('customStyle') || '{author}, {year}, {title}';
        let validationTimeouts = {};

        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                let date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + value + expires + "; path=/";
        }

        function getCookie(name) {
            let nameEQ = name + "=";
            let ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        function saveState() {
            const snippets = [];
            for (let i = 1; i <= snippetCount; i++) {
                snippets.push({
                    snippet: document.getElementById(`snippet${i}`)?.innerHTML || '',
                    ref: document.getElementById(`ref${i}`)?.value || '',
                    source: document.getElementById(`source${i}`)?.value || '',
                    deadline: document.getElementById(`deadline${i}`)?.value || ''
                });
            }
            history = history.slice(0, historyIndex + 1);
            history.push({ snippets, snippetCount });
            historyIndex++;
            autoSave();
        }

        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                restoreState();
            }
        }

        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                restoreState();
            }
        }

        function restoreState() {
            const state = history[historyIndex];
            snippetCount = state.snippetCount;
            const container = document.getElementById('snippets-container');
            container.innerHTML = '';
            state.snippets.forEach((item, i) => {
                const index = i + 1;
                const newSnippet = document.createElement('div');
                newSnippet.className = 'snippet';
                newSnippet.draggable = true;
                newSnippet.innerHTML = `
                    <h3 class="snippet-header">Text Snippet ${index}</h3>
                    <div class="style-toolbar">
                        <button onclick="applyStyle('bold', ${index})" aria-label="Bold text">B</button>
                        <button onclick="applyStyle('italic', ${index})" aria-label="Italic text">I</button>
                        <select onchange="applyStyle('fontSize', ${index}, this.value)" aria-label="Font size">
                            <option value="12px">12px</option>
                            <option value="14px">14px</option>
                            <option value="16px" selected>16px</option>
                        </select>
                        <button onclick="applyTemplate(${index})" aria-label="Apply snippet template">Template</button>
                    </div>
                    <div id="snippet${index}" class="snippet-content" contenteditable="true" aria-label="Text Snippet ${index}">${item.snippet}</div>
                    <span id="word-count${index}">Words: ${countWords(item.snippet)}</span>
                    <select id="source${index}" aria-label="Source type for Snippet ${index}">
                        <option value="book" ${item.source === 'book' ? 'selected' : ''}>Book</option>
                        <option value="journal" ${item.source === 'journal' ? 'selected' : ''}>Journal</option>
                        <option value="website" ${item.source === 'website' ? 'selected' : ''}>Website</option>
                    </select>
                    <div class="tooltip">
                        <input type="text" id="ref${index}" placeholder="${getPlaceholder()}" value="${item.ref}" aria-label="Reference for Snippet ${index}">
                        <span class="tooltiptext" id="ref-tooltip${index}"></span>
                    </div>
                    <span id="error${index}" class="error"></span>
                    <span id="correct${index}" class="correct">Correct</span>
                    <input type="date" id="deadline${index}" value="${item.deadline}" aria-label="Deadline for Snippet ${index}">
                `;
                container.appendChild(newSnippet);
                addDragEvents(newSnippet);
            });
            updateAutoAdd();
            updatePreview();
            updateValidation();
            updateProgress();
        }

        function countWords(text) {
            const cleanText = text.replace(/<[^>]+>/g, '').trim();
            return cleanText.split(/\s+/).filter(w => w.length > 0).length;
        }

        function addSnippet() {
            if (countWords(document.getElementById(`snippet${snippetCount}`).innerHTML) > 5000) {
                alert('Snippet exceeds 5000 words.');
                return;
            }
            snippetCount++;
            const container = document.getElementById('snippets-container');
            const newSnippet = document.createElement('div');
            newSnippet.className = 'snippet';
            newSnippet.draggable = true;
            newSnippet.innerHTML = `
                <h3 class="snippet-header">Text Snippet ${snippetCount}</h3>
                <div class="style-toolbar">
                    <button onclick="applyStyle('bold', ${snippetCount})" aria-label="Bold text">B</button>
                    <button onclick="applyStyle('italic', ${snippetCount})" aria-label="Italic text">I</button>
                    <select onchange="applyStyle('fontSize', ${snippetCount}, this.value)" aria-label="Font size">
                        <option value="12px">12px</option>
                        <option value="14px">14px</option>
                        <option value="16px" selected>16px</option>
                    </select>
                    <button onclick="applyTemplate(${snippetCount})" aria-label="Apply snippet template">Template</button>
                </div>
                <div id="snippet${snippetCount}" class="snippet-content" contenteditable="true" aria-label="Text Snippet ${snippetCount}"></div>
                <span id="word-count${snippetCount}">Words: 0</span>
                <select id="source${snippetCount}" aria-label="Source type for Snippet ${snippetCount}">
                    <option value="book">Book</option>
                    <option value="journal">Journal</option>
                    <option value="website">Website</option>
                </select>
                <div class="tooltip">
                    <input type="text" id="ref${snippetCount}" placeholder="${getPlaceholder()}" aria-label="Reference for Snippet ${snippetCount}">
                    <span class="tooltiptext" id="ref-tooltip${snippetCount}"></span>
                </div>
                <span id="error${snippetCount}" class="error"></span>
                <span id="correct${snippetCount}" class="correct">Correct</span>
                <input type="date" id="deadline${snippetCount}" aria-label="Deadline for Snippet ${snippetCount}">
            `;
            container.appendChild(newSnippet);
            newSnippet.scrollIntoView({ behavior: 'smooth' });
            addDragEvents(newSnippet);
            updateAutoAdd();
            saveState();
            updatePreview();
        }

        function updateAutoAdd() {
            const lastSnippet = document.getElementById(`snippet${snippetCount}`);
            lastSnippet.addEventListener('input', function() {
                if (lastSnippet.innerText.trim() !== '') {
                    addSnippet();
                }
            }, { once: true });
        }

        function getPlaceholder() {
            const style = document.getElementById('citationStyle').value;
            switch (style) {
                case 'apa': return 'e.g., Smith, J. (2020). Title. Journal.';
                case 'mla': return 'e.g., Smith, John. "Title." Journal, 2020.';
                case 'chicago': return 'e.g., Smith, John. 2020. "Title." Journal.';
                case 'harvard': return 'e.g., Smith, J., 2020. Title. Journal.';
                case 'ieee': return 'e.g., J. Smith, "Title," Journal, 2020.';
                case 'ama': return 'e.g., Smith J. Title. Journal. 2020.';
                case 'vancouver': return 'e.g., Smith J. Title. Journal 2020.';
                case 'turabian': return 'e.g., Smith, John. 2020. Title. Journal.';
                case 'oscola': return 'e.g., Smith J, "Title" (2020) Journal.';
                case 'bluebook': return 'e.g., John Smith, Title, Journal (2020).';
                case 'custom': return `e.g., ${customStyle.replace('{author}', 'Smith').replace('{year}', '2020').replace('{title}', 'Title')}`;
                default: return 'Reference';
            }
        }

        function validateReference(ref, style, index) {
            const patterns = {
                apa: /^[\w\s]+,\s*[\w\s]+\.\s*\(\d{4}\)\.\s*.+$/,
                mla: /^[\w\s]+,\s*[\w\s]+\.\s*".+"\.\s*.+,\s*\d{4}\.$/,
                chicago: /^[\w\s]+,\s*[\w\s]+\.\s*\d{4}\.\s*".+"\.\s*.+$/,
                harvard: /^[\w\s]+,\s*[\w\s]+,\s*\d{4}\.\s*.+\.\s*.+$/,
                ieee: /^[\w\s]+\.\s*".+",\s*.+,\s*\d{4}\.$/,
                ama: /^[\w\s]+\.\s*.+\.\s*.+\.\s*\d{4}\.$/,
                vancouver: /^[\w\s]+\.\s*.+\.\s*.+\s*\d{4}\.$/,
                turabian: /^[\w\s]+,\s*[\w\s]+\.\s*\d{4}\.\s*.+\.\s*.+$/,
                oscola: /^[\w\s]+\s*,\s*".+"\s*\(\d{4}\)\s*.+$/,
                bluebook: /^[\w\s]+,\s*.+,\s*.+\s*\(\d{4}\)\.$/,
                custom: new RegExp(customStyle.replace('{author}', '[\\w\\s]+').replace('{year}', '\\d{4}').replace('{title}', '.+'))
            };
            const errorSpan = document.getElementById(`error${index + 1}`);
            const correctSpan = document.getElementById(`correct${index + 1}`);
            if (!ref) {
                errorSpan.style.display = 'none';
                correctSpan.style.display = 'none';
                return true;
            }
            if (patterns[style].test(ref)) {
                errorSpan.style.display = 'none';
                correctSpan.style.display = 'block';
                return true;
            } else {
                errorSpan.innerText = `Incorrect citation for ${style.toUpperCase()} format.`;
                errorSpan.style.display = 'block';
                correctSpan.style.display = 'none';
                return false;
            }
        }

        function updateValidation(index) {
            clearTimeout(validationTimeouts[index]);
            validationTimeouts[index] = setTimeout(() => {
                const ref = document.getElementById(`ref${index}`).value;
                validateReference(ref, document.getElementById('citationStyle').value, index - 1);
            }, 500);
        }

        function updatePlaceholders() {
            for (let i = 1; i <= snippetCount; i++) {
                const refInput = document.getElementById(`ref${i}`);
                if (refInput) refInput.placeholder = getPlaceholder();
                const tooltip = document.getElementById(`ref-tooltip${i}`);
                if (tooltip) tooltip.innerText = getPlaceholder();
                validateReference(refInput.value, document.getElementById('citationStyle').value, i - 1);
            }
            updatePreview();
        }

        function applyStyle(style, index, value) {
            const snippet = document.getElementById(`snippet${index}`);
            if (style === 'fontSize') {
                snippet.style.fontSize = value;
            } else {
                document.execCommand(style, false, null);
            }
            saveState();
            updatePreview();
        }

        function applyTemplate(index) {
            const templates = [
                'This study findsâ€¦',
                'According toâ€¦',
                'The results suggestâ€¦'
            ];
            const snippet = document.getElementById(`snippet${index}`);
            snippet.innerText = templates[Math.floor(Math.random() * templates.length)];
            saveState();
            updatePreview();
        }

        function importCitations(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                if (file.name.endsWith('.bib')) {
                    // Simplified BibTeX parsing
                    const entries = text.split('@').filter(e => e.includes('author')).slice(0, snippetCount);
                    entries.forEach((entry, i) => {
                        const index = i + 1;
                        const author = entry.match(/author\s*=\s*{([^}]+)}/)?.[1] || '';
                        const year = entry.match(/year\s*=\s*{(\d{4})}/)?.[1] || '';
                        const title = entry.match(/title\s*=\s*{([^}]+)}/)?.[1] || '';
                        const refInput = document.getElementById(`ref${index}`);
                        if (refInput) refInput.value = `${author}, ${year}, ${title}`;
                        validateReference(refInput.value, document.getElementById('citationStyle').value, i);
                    });
                } else if (file.name.endsWith('.ris')) {
                    // Simplified RIS parsing
                    const entries = text.split('ER  -').filter(e => e.includes('AU  -')).slice(0, snippetCount);
                    entries.forEach((entry, i) => {
                        const index = i + 1;
                        const author = entry.match(/AU  -\s*([^\n]+)/)?.[1] || '';
                        const year = entry.match(/PY  -\s*(\d{4})/)?.[1] || '';
                        const title = entry.match(/TI  -\s*([^\n]+)/)?.[1] || '';
                        const refInput = document.getElementById(`ref${index}`);
                        if (refInput) refInput.value = `${author}, ${year}, ${title}`;
                        validateReference(refInput.value, document.getElementById('citationStyle').value, i);
                    });
                } else {
                    alert('Only BibTeX and RIS formats are supported for now.');
                }
                saveState();
                updatePreview();
            };
            reader.readAsText(file);
        }

        function updatePreview() {
            const snippets = [];
            const references = [];
            const sources = [];
            const deadlines = [];
            for (let i = 1; i <= snippetCount; i++) {
                const snippet = document.getElementById(`snippet${i}`)?.innerHTML || '';
                const ref = document.getElementById(`ref${i}`)?.value || '';
                const source = document.getElementById(`source${i}`)?.value || '';
                const deadline = document.getElementById(`deadline${i}`)?.value || '';
                if (snippet && ref) {
                    snippets.push(snippet);
                    references.push(ref);
                    sources.push(source);
                    deadlines.push(deadline);
                }
            }
            const style = document.getElementById('citationStyle').value;
            const template = document.getElementById('template').value;
            const font = document.getElementById('font').value;
            let combined = applyTemplate(snippets, references, sources, deadlines, template);
            const bibliography = generateBibliography(references, sources, style);
            const outputText = combined + "\n\nBibliography:\n" + bibliography;
            document.getElementById('preview-content').innerText = outputText;
            document.getElementById('preview-content').style.fontFamily = font;
            updateWordCounts();
            updateExportPreview(outputText);
            updateProgress();
        }

        function applyTemplate(snippets, references, sources, deadlines, template) {
            let combined = snippets.map((s, i) => `${s} (${references[i].split(",")[0]}, ${references[i].split(",")[1]})`).join("\n\n");
            switch (template) {
                case 'literature':
                    return `Literature Review\n\n${combined}`;
                case 'annotated':
                    return snippets.map((s, i) => `${s}\nReference: ${references[i]}`).join("\n\n");
                case 'proposal':
                    return `Research Proposal\n\n${combined}`;
                case 'abstract':
                    return `Abstract\n\n${combined}`;
                case 'study':
                    return snippets.map(s => `- ${s}`).join("\n");
                case 'essay':
                    return `Essay Outline\n\n${combined}`;
                case 'grant':
                    return `Grant Proposal\n\n${combined}`;
                case 'reading':
                    return `Reading List\n\n${references.join("\n")}`;
                case 'summary':
                    return `Summary Report\n\n${snippets.map(s => s.slice(0, s.length / 2)).join("\n\n")}`;
                case 'technical':
                    return `Technical Report\n\n${combined}`;
                default:
                    return combined;
            }
        }

        function generateBibliography(references, sources, style) {
            const grouped = { book: [], journal: [], website: [] };
            references.forEach((ref, i) => {
                if (sources[i]) grouped[sources[i]].push(ref);
            });
            let bib = "";
            ['book', 'journal', 'website'].forEach(type => {
                if (grouped[type].length) {
                    bib += `${type.charAt(0).toUpperCase() + type.slice(1)}s:\n`;
                    grouped[type].forEach(ref => {
                        const parts = ref.split(",").map(p => p.trim());
                        if (parts.length < 2) return;
                        if (style === 'custom') {
                            bib += customStyle
                                .replace('{author}', parts[0])
                                .replace('{year}', parts[1])
                                .replace('{title}', parts[2] || 'Untitled') + '\n';
                        } else {
                            switch (style) {
                                case 'apa':
                                    bib += `${parts[0]}. (${parts[1]}). ${parts[2] || "Untitled"}.\n`;
                                    break;
                                case 'mla':
                                    bib += `${parts[0].split(" ").pop()}, ${parts[0].split(" ")[0]}. "${parts[2] || "Untitled"}." ${parts[1]}.\n`;
                                    break;
                                default:
                                    bib += `${parts[0]}, ${parts[1]}, ${parts[2] || "Untitled"}\n`;
                            }
                        }
                    });
                }
            });
            return bib;
        }

        function combineText() {
            const snippets = [];
            const references = [];
            const sources = [];
            const deadlines = [];
            const invalidRefs = [];
            for (let i = 1; i <= snippetCount; i++) {
                const snippet = document.getElementById(`snippet${i}`).innerHTML;
                const ref = document.getElementById(`ref${i}`).value;
                const source = document.getElementById(`source${i}`).value;
                const deadline = document.getElementById(`deadline${i}`).value;
                if (countWords(snippet) > 5000) {
                    alert(`Snippet ${i} exceeds 5000 words.`);
                    return;
                }
                if (snippet && ref) {
                    snippets.push(snippet);
                    references.push(ref);
                    sources.push(source);
                    deadlines.push(deadline);
                    if (!validateReference(ref, document.getElementById('citationStyle').value, i - 1)) {
                        invalidRefs.push(i);
                    }
                }
            }
            const style = document.getElementById('citationStyle').value;
            const template = document.getElementById('template').value;
            const font = document.getElementById('font').value;
            let combined = applyTemplate(snippets, references, sources, deadlines, template);
            const bibliography = generateBibliography(references, sources, style);
            const outputText = combined + "\n\nBibliography:\n" + bibliography;
            document.getElementById('output-text').innerHTML = outputText.replace(/\n/g, '<br>');
            document.getElementById('output-text').style.fontFamily = font;
            document.getElementById('errors-list').innerText = invalidRefs.length ? `Incorrect references: ${formatRanges(invalidRefs)}` : '';
            document.getElementById('output-modal').style.display = 'flex';
            document.getElementById('progress-bar').style.width = '100%';
            setTimeout(() => document.getElementById('progress-bar').style.width = '0%', 1000);
            updateWordCounts();
            saveVersion(outputText);
        }

        function formatRanges(numbers) {
            if (!numbers.length) return '';
            numbers.sort((a, b) => a - b);
            const ranges = [];
            let start = numbers[0];
            let prev = start;
            for (let i = 1; i < numbers.length; i++) {
                if (numbers[i] !== prev + 1) {
                    if (start === prev) ranges.push(start);
                    else ranges.push(`${start}-${prev}`);
                    start = numbers[i];
                }
                prev = numbers[i];
            }
            if (start === prev) ranges.push(start);
            else ranges.push(`${start}-${prev}`);
            return ranges.join(', ');
        }

        function updateWordCounts() {
            for (let i = 1; i <= snippetCount; i++) {
                const snippet = document.getElementById(`snippet${i}`)?.innerHTML || '';
                const wordCountSpan = document.getElementById(`word-count${i}`);
                if (wordCountSpan) wordCountSpan.innerText = `Words: ${countWords(snippet)}`;
            }
            const outputText = document.getElementById('output-text').innerText;
            const snippetsOnly = outputText.split('\n\nBibliography:\n')[0].replace(/\([\w\s,]+\)/g, '');
            const totalWords = countWords(outputText);
            const snippetsWords = countWords(snippetsOnly);
            document.getElementById('word-count-output').innerText = `Total Words: ${totalWords} (Excluding Citations: ${snippetsWords})`;
        }

        function updateProgress() {
            const completed = Array.from(document.querySelectorAll('.snippet-content')).filter(s => s.innerText.trim() !== '').length;
            const total = snippetCount;
            document.getElementById('progress').innerText = `${Math.round((completed / total) * 100)}%`;
        }

        function updateExportPreview(text) {
            document.getElementById('export-preview').innerText = `Export Preview:\n${text.slice(0, 100)}...`;
        }

        function closeModal() {
            document.getElementById('output-modal').style.display = 'none';
            document.getElementById('save-online-options').style.display = 'none';
            document.getElementById('save-locally-options').style.display = 'none';
        }

        function copyText() {
            const text = document.getElementById('output-text').innerText;
            navigator.clipboard.writeText(text).then(() => {
                const message = document.getElementById('copy-message');
                message.style.display = 'inline';
                setTimeout(() => message.style.display = 'none', 2000);
                setCookie('lastSave', 'clipboard', 30);
            });
        }

        function savePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFont(document.getElementById('font').value);
            doc.text(document.getElementById('output-text').innerText, 10, 10);
            doc.save('research_synthesis.pdf');
            setCookie('lastSave', 'pdf', 30);
        }

        function saveDocx() {
            const text = document.getElementById('output-text').innerText;
            const doc = new docxtemplater(new JSZip(), { paragraphLoop: true });
            const content = `
                <w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
                    <w:body>
                        <w:p><w:r><w:t>${text.replace(/\n/g, '</w:t></w:r></w:p><w:p><w:r><w:t>')}</w:t></w:r></w:p>
                    </w:body>
                </w:document>`;
            doc.loadZip(new JSZip()).setData(content).render();
            const blob = doc.getZip().generate({ type: 'blob' });
            saveAs(blob, 'research_synthesis.docx');
            setCookie('lastSave', 'docx', 30);
        }

        function saveText() {
            const text = document.getElementById('output-text').innerText;
            const blob = new Blob([text], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'research_synthesis.txt';
            link.click();
            setCookie('lastSave', 'text', 30);
        }

        function saveMarkdown() {
            const text = document.getElementById('output-text').innerText;
            const markdown = text.replace(/^Bibliography:\n/, '## Bibliography\n');
            const blob = new Blob([markdown], { type: 'text/markdown' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'research_synthesis.md';
            link.click();
            setCookie('lastSave', 'markdown', 30);
        }

        function saveRIS() {
            const references = [];
            for (let i = 1; i <= snippetCount; i++) {
                const ref = document.getElementById(`ref${i}`).value;
                if (ref) references.push(ref);
            }
            let ris = '';
            references.forEach(ref => {
                const parts = ref.split(",").map(p => p.trim());
                ris += `TY  - JOUR\nAU  - ${parts[0]}\nPY  - ${parts[1]}\nTI  - ${parts[2] || "Untitled"}\nER  -\n\n`;
            });
            const blob = new Blob([ris], { type: 'application/x-research-info-systems' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'research_synthesis.ris';
            link.click();
            setCookie('lastSave', 'ris', 30);
        }

        function saveLatex() {
            const text = document.getElementById('output-text').innerText;
            const latex = `\\documentclass{article}\n\\begin{document}\n${text.replace(/\n/g, '\\\\\n')}\n\\end{document}`;
            const blob = new Blob([latex], { type: 'application/x-tex' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'research_synthesis.tex';
            link.click();
            setCookie('lastSave', 'latex', 30);
        }

        function saveFlashcards() {
            const snippets = [];
            const references = [];
            for (let i = 1; i <= snippetCount; i++) {
                const snippet = document.getElementById(`snippet${i}`).innerText;
                const ref = document.getElementById(`ref${i}`).value;
                if (snippet && ref) {
                    snippets.push(snippet);
                    references.push(ref);
                }
            }
            const text = snippets.map((s, i) => `${s}\t${references[i]}`).join('\n');
            const blob = new Blob([text], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'research_synthesis_flashcards.txt';
            link.click();
            setCookie('lastSave', 'flashcards', 30);
        }

        function saveZip() {
            const zip = new JSZip();
            const text = document.getElementById('output-text').innerText;
            zip.file('research_synthesis.txt', text);
            zip.file('research_synthesis.md', text.replace(/^Bibliography:\n/, '## Bibliography\n'));
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(text, 10, 10);
            zip.file('research_synthesis.pdf', doc.output('blob'));
            const docx = new docxtemplater(new JSZip(), { paragraphLoop: true });
            const content = `
                <w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
                    <w:body>
                        <w:p><w:r><w:t>${text.replace(/\n/g, '</w:t></w:r></w:p><w:p><w:r><w:t>')}</w:t></w:r></w:p>
                    </w:body>
                </w:document>`;
            docx.loadZip(new JSZip()).setData(content).render();
            zip.file('research_synthesis.docx', docx.getZip().generate({ type: 'blob' }));
            let ris = '';
            for (let i = 1; i <= snippetCount; i++) {
                const ref = document.getElementById(`ref${i}`).value;
                if (ref) {
                    const parts = ref.split(",").map(p => p.trim());
                    ris += `TY  - JOUR\nAU  - ${parts[0]}\nPY  - ${parts[1]}\nTI  - ${parts[2] || "Untitled"}\nER  -\n\n`;
                }
            }
            zip.file('research_synthesis.ris', ris);
            zip.generateAsync({ type: 'blob' }).then(blob => {
                saveAs(blob, 'research_synthesis.zip');
            });
            setCookie('lastSave', 'zip', 30);
        }

        function saveToGoogleDrive() {
            alert('Google Drive integration requires API setup. Placeholder for now.');
            setCookie('lastSave', 'googleDrive', 30);
        }

        function saveToDropbox() {
            alert('Dropbox integration requires API setup. Placeholder for now.');
            setCookie('lastSave', 'dropbox', 30);
        }

        function saveToOneDrive() {
            alert('OneDrive integration requires API setup. Placeholder for now.');
            setCookie('lastSave', 'onedrive', 30);
        }

        function shareSecurely() {
            const text = document.getElementById('output-text').innerText;
            const password = prompt('Enter a password for secure sharing:');
            if (password) {
                const encrypted = btoa(text + '|' + password);
                const url = `${window.location.href}#${encrypted}`;
                navigator.clipboard.writeText(url).then(() => alert('Secure URL copied to clipboard.'));
            }
        }

        function toggleSaveOnline() {
            const options = document.getElementById('save-online-options');
            options.style.display = options.style.display === 'block' ? 'none' : 'block';
        }

        function toggleSaveLocally() {
            const options = document.getElementById('save-locally-options');
            options.style.display = options.style.display === 'block' ? 'none' : 'block';
        }

        function saveCustomStyle() {
            customStyle = document.getElementById('custom-style-input').value;
            localStorage.setItem('customStyle', customStyle);
            updatePlaceholders();
            document.getElementById('custom-style-modal').style.display = 'none';
        }

        function closeCustomStyleModal() {
            document.getElementById('custom-style-modal').style.display = 'none';
        }

        function showRequestForm() {
            document.getElementById('request-form').style.display = 'block';
        }

        function closeRequestForm() {
            document.getElementById('request-form').style.display = 'none';
        }

        function submitRequest() {
            const request = document.getElementById('feature-request').value;
            if (request) {
                localStorage.setItem('featureRequest', request);
                alert('Feature request submitted!');
                closeRequestForm();
            }
        }

        function savePreferences() {
            preferences = {
                citationStyle: document.getElementById('citationStyle').value,
                font: document.getElementById('font').value,
                template: document.getElementById('template').value
            };
            localStorage.setItem('preferences', JSON.stringify(preferences));
            alert('Preferences saved!');
        }

        function saveVersion(text) {
            versions.push({ text, timestamp: new Date().toISOString() });
            if (versions.length > 10) versions.shift();
            localStorage.setItem('versions', JSON.stringify(versions));
        }

        function showVersions() {
            const versionList = versions.map((v, i) => `${i + 1}. ${v.timestamp}`).join('\n');
            const index = prompt(`Select a version:\n${versionList}`);
            if (index && versions[index - 1]) {
                document.getElementById('output-text').innerText = versions[index - 1].text;
                document.getElementById('output-modal').style.display = 'flex';
            }
        }

        function autoSave() {
            const snippets = [];
            for (let i = 1; i <= snippetCount; i++) {
                snippets.push({
                    snippet: document.getElementById(`snippet${i}`)?.innerHTML || '',
                    ref: document.getElementById(`ref${i}`)?.value || '',
                    source: document.getElementById(`source${i}`)?.value || '',
                    deadline: document.getElementById(`deadline${i}`)?.value || ''
                });
            }
            localStorage.setItem('autoSave', JSON.stringify({ snippets, snippetCount }));
        }

        function loadAutoSave() {
            const saved = JSON.parse(localStorage.getItem('autoSave'));
            if (saved) {
                snippetCount = saved.snippetCount;
                const container = document.getElementById('snippets-container');
                container.innerHTML = '';
                saved.snippets.forEach((item, i) => {
                    const index = i + 1;
                    const newSnippet = document.createElement('div');
                    newSnippet.className = 'snippet';
                    newSnippet.draggable = true;
                    newSnippet.innerHTML = `
                        <h3 class="snippet-header">Text Snippet ${index}</h3>
                        <div class="style-toolbar">
                            <button onclick="applyStyle('bold', ${index})" aria-label="Bold text">B</button>
                            <button onclick="applyStyle('italic', ${index})" aria-label="Italic text">I</button>
                            <select onchange="applyStyle('fontSize', ${index}, this.value)" aria-label="Font size">
                                <option value="12px">12px</option>
                                <option value="14px">14px</option>
                                <option value="16px" selected>16px</option>
                            </select>
                            <button onclick="applyTemplate(${index})" aria-label="Apply snippet template">Template</button>
                        </div>
                        <div id="snippet${index}" class="snippet-content" contenteditable="true" aria-label="Text Snippet ${index}">${item.snippet}</div>
                        <span id="word-count${index}">Words: ${countWords(item.snippet)}</span>
                        <select id="source${index}" aria-label="Source type for Snippet ${index}">
                            <option value="book" ${item.source === 'book' ? 'selected' : ''}>Book</option>
                            <option value="journal" ${item.source === 'journal' ? 'selected' : ''}>Journal</option>
                            <option value="website" ${item.source === 'website' ? 'selected' : ''}>Website</option>
                        </select>
                        <div class="tooltip">
                            <input type="text" id="ref${index}" placeholder="${getPlaceholder()}" value="${item.ref}" aria-label="Reference for Snippet ${index}">
                            <span class="tooltiptext" id="ref-tooltip${index}"></span>
                        </div>
                        <span id="error${index}" class="error"></span>
                        <span id="correct${index}" class="correct">Correct</span>
                        <input type="date" id="deadline${index}" value="${item.deadline}" aria-label="Deadline for Snippet ${index}">
                    `;
                    container.appendChild(newSnippet);
                    addDragEvents(newSnippet);
                });
                updateAutoAdd();
                updatePreview();
                updateValidation();
            }
        }

        function addDragEvents(snippet) {
            snippet.addEventListener('dragstart', e => {
                e.dataTransfer.setData('text/plain', snippet.querySelector('h3').innerText.split(' ')[2]);
            });
            snippet.addEventListener('dragover', e => e.preventDefault());
            snippet.addEventListener('drop', e => {
                e.preventDefault();
                const draggedIndex = parseInt(e.dataTransfer.getData('text/plain'));
                const targetIndex = parseInt(snippet.querySelector('h3').innerText.split(' ')[2]);
                if (draggedIndex !== targetIndex) {
                    const container = document.getElementById('snippets-container');
                    const snippets = Array.from(container.children);
                    const dragged = snippets[draggedIndex - 1];
                    const target = snippets[targetIndex - 1];
                    if (draggedIndex < targetIndex) {
                        container.insertBefore(dragged, target.nextSibling);
                    } else {
                        container.insertBefore(dragged, target);
                    }
                    renumberSnippets();
                    saveState();
                    updatePreview();
                }
            });
        }

        function renumberSnippets() {
            const snippets = document.querySelectorAll('.snippet');
            snippets.forEach((snippet, i) => {
                const index = i + 1;
                snippet.querySelector('h3').innerText = `Text Snippet ${index}`;
                snippet.querySelector('.snippet-content').id = `snippet${index}`;
                snippet.querySelector('.style-toolbar select').setAttribute('onchange', `applyStyle('fontSize', ${index}, this.value)`);
                snippet.querySelectorAll('.style-toolbar button')[0].setAttribute('onclick', `applyStyle('bold', ${index})`);
                snippet.querySelectorAll('.style-toolbar button')[1].setAttribute('onclick', `applyStyle('italic', ${index})`);
                snippet.querySelectorAll('.style-toolbar button')[2].setAttribute('onclick', `applyTemplate(${index})`);
                snippet.querySelector('span').id = `word-count${index}`;
                snippet.querySelector('select').id = `source${index}`;
                snippet.querySelector('input[type="text"]').id = `ref${index}`;
                snippet.querySelector('.tooltiptext').id = `ref-tooltip${index}`;
                snippet.querySelector('.error').id = `error${index}`;
                snippet.querySelector('.correct').id = `correct${index}`;
                snippet.querySelector('input[type="date"]').id = `deadline${index}`;
            });
            snippetCount = snippets.length;
        }

        document.getElementById('import-citations').addEventListener('change', importCitations);
        document.getElementById('citationStyle').addEventListener('change', () => {
            if (document.getElementById('citationStyle').value === 'custom') {
                document.getElementById('custom-style-modal').style.display = 'block';
            }
        });
        document.querySelectorAll('textarea, input, .snippet-content').forEach(el => {
            el.addEventListener('input', () => {
                saveState();
                updatePreview();
                if (el.id.startsWith('ref')) {
                    updateValidation(parseInt(el.id.replace('ref', '')));
                }
            });
        });
        document.addEventListener('keydown', e => {
            if (e.ctrlKey && e.key === 'z') {
                e.preventDefault();
                undo();
            }
            if (e.ctrlKey && e.key === 'y') {
                e.preventDefault();
                redo();
            }
        });
        document.addEventListener('click', e => {
            if (!e.target.closest('.save-options') && !e.target.closest('button[aria-label="Save online"]') && !e.target.closest('button[aria-label="Save locally"]')) {
                document.getElementById('save-online-options').style.display = 'none';
                document.getElementById('save-locally-options').style.display = 'none';
            }
        });
        setInterval(autoSave, 5000);
        const tips = ['Write first, edit later.', 'Clarity is key.', 'Take breaks to stay focused.'];
        document.getElementById('motivational-tip').innerText = tips[Math.floor(Math.random() * tips.length)];
        if (preferences.citationStyle) document.getElementById('citationStyle').value = preferences.citationStyle;
        if (preferences.font) document.getElementById('font').value = preferences.font;
        if (preferences.template) document.getElementById('template').value = preferences.template;
        loadAutoSave();
        updatePlaceholders();
    </script>
</body>
</html>
