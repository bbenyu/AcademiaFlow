<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text Combiner for Researchers</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.28.0/docxtemplater.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --bg-color: #f0f0f0;
            --text-color: #333;
            --snippet-bg: #fff;
            --border-color: #ccc;
        }
        .dark-mode {
            --bg-color: #333;
            --text-color: #ddd;
            --snippet-bg: #444;
            --border-color: #555;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 20px;
            font-size: 18px;
            display: flex;
        }
        h1 { margin-top: 0; }
        p { color: var(--text-color); margin-bottom: 20px; }
        #preview {
            width: 25%;
            min-width: 200px;
            max-width: 400px;
            resize: horizontal;
            overflow: auto;
            background-color: var(--snippet-bg);
            border-right: 2px solid var(--border-color);
            padding: 10px;
            margin-right: 20px;
        }
        #preview-content {
            white-space: pre-wrap;
            font-size: 16px;
        }
        #main-content {
            flex: 1;
        }
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .snippet {
            background-color: var(--snippet-bg);
            border: 1px solid var(--border-color);
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            opacity: 0;
            animation: fadeIn 0.5s forwards;
        }
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        textarea {
            width: 100%;
            height: 80px;
            margin: 10px 0;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            font-size: 16px;
            transition: height 0.3s;
            background-color: var(--snippet-bg);
            color: var(--text-color);
        }
        textarea:focus { height: 120px; }
        input {
            width: 100%;
            margin: 5px 0;
            padding: 5px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            font-size: 16px;
            background-color: var(--snippet-bg);
            color: var(--text-color);
        }
        .error {
            color: red;
            font-size: 14px;
            display: none;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #0056b3; }
        select {
            padding: 12px;
            font-size: 18px;
            margin: 10px;
            width: 200px;
            background-color: var(--snippet-bg);
            color: var(--text-color);
        }
        #output-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #output-content {
            background-color: var(--snippet-bg);
            color: var(--text-color);
            padding: 20px;
            border-radius: 5px;
            width: 80%;
            max-width: 700px;
            text-align: left;
            position: relative;
        }
        #output-text {
            white-space: pre-wrap;
            margin-bottom: 20px;
            font-size: 16px;
            cursor: text;
        }
        #copy-message {
            display: none;
            color: green;
            margin-right: 10px;
            animation: fadeInOut 2s;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; }
        }
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 30px;
            padding: 10px;
        }
        .button-container {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            flex-wrap: nowrap;
        }
        .save-options {
            display: none;
            position: absolute;
            background-color: var(--snippet-bg);
            border: 1px solid var(--border-color);
            padding: 10px;
            border-radius: 5px;
        }
        .save-options button {
            display: block;
            width: 100%;
            text-align: left;
        }
    </style>
</head>
<body>
    <div id="preview">
        <h3>Live Preview</h3>
        <div id="preview-content"></div>
    </div>
    <div id="main-content">
        <h1>Text Combiner for Researchers</h1>
        <p>
            Combine text snippets and manage citations effortlessly. Input your snippets and references, choose a citation style, and generate a polished output with a bibliography.
        </p>
        <div id="snippets-container" class="grid-container">
            <div class="snippet">
                <h3>Text Snippet 1</h3>
                <textarea id="snippet1" placeholder="Paste your first text snippet here" spellcheck="true" aria-label="Text Snippet 1"></textarea>
                <span id="word-count1">Words: 0</span>
                <input type="text" id="ref1" placeholder="e.g., Smith, J. (2020). Title. Journal." aria-label="Reference for Snippet 1">
                <span id="error1" class="error"></span>
            </div>
            <div class="snippet">
                <h3>Text Snippet 2</h3>
                <textarea id="snippet2" placeholder="Paste your second text snippet here" spellcheck="true" aria-label="Text Snippet 2"></textarea>
                <span id="word-count2">Words: 0</span>
                <input type="text" id="ref2" placeholder="e.g., Smith, J. (2020). Title. Journal." aria-label="Reference for Snippet 2">
                <span id="error2" class="error"></span>
            </div>
            <div class="snippet">
                <h3>Text Snippet 3</h3>
                <textarea id="snippet3" placeholder="Paste your third text snippet here" spellcheck="true" aria-label="Text Snippet 3"></textarea>
                <span id="word-count3">Words: 0</span>
                <input type="text" id="ref3" placeholder="e.g., Smith, J. (2020). Title. Journal." aria-label="Reference for Snippet 3">
                <span id="error3" class="error"></span>
            </div>
        </div>
        <label><input type="checkbox" id="categorize" aria-label="Categorize snippets by theme"> Categorize Snippets by Theme</label>
        <select id="citationStyle" onchange="updatePlaceholders()" aria-label="Select citation style">
            <option value="apa">APA</option>
            <option value="mla">MLA</option>
            <option value="chicago">Chicago</option>
            <option value="harvard">Harvard</option>
            <option value="ieee">IEEE</option>
            <option value="ama">AMA</option>
            <option value="vancouver">Vancouver</option>
            <option value="turabian">Turabian</option>
            <option value="oscola">OSCOLA</option>
            <option value="bluebook">Bluebook</option>
        </select>
        <button onclick="combineText()" aria-label="Combine text and generate bibliography">Combine & Generate Bibliography</button>
        <button onclick="clearAll()" aria-label="Clear all snippets">Clear All</button>
        <button onclick="undo()" aria-label="Undo last action">Undo</button>
        <button onclick="redo()" aria-label="Redo last action">Redo</button>
        <button onclick="toggleDarkMode()" aria-label="Toggle dark mode">Toggle Dark Mode</button>
        <div id="output-modal" role="dialog" aria-label="Result dialog">
            <div id="output-content">
                <span class="close-btn" onclick="closeModal()" aria-label="Close dialog">Ã—</span>
                <h2>Your Research Synthesis</h2>
                <div id="output-text" aria-label="Combined text and bibliography"></div>
                <div id="word-count-output">Total Words: 0 (Excluding Citations: 0)</div>
                <div class="button-container">
                    <span id="copy-message">Copied!</span>
                    <button onclick="copyText()" aria-label="Copy to clipboard">Copy to Clipboard</button>
                    <button onclick="toggleSaveOnline()" aria-label="Save online">Save Online</button>
                    <div id="save-online-options" class="save-options">
                        <button onclick="saveToGoogleDrive()">Google Drive</button>
                        <button onclick="saveToDropbox()">Dropbox</button>
                        <button onclick="saveToOneDrive()">OneDrive</button>
                    </div>
                    <button onclick="toggleSaveLocally()" aria-label="Save locally">Save Locally</button>
                    <div id="save-locally-options" class="save-options">
                        <button onclick="savePDF()">PDF</button>
                        <button onclick="saveDocx()">DOCX</button>
                        <button onclick="saveText()">Text</button>
                        <button onclick="saveMarkdown()">Markdown</button>
                        <button onclick="saveRIS()">RIS</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        let snippetCount = 3;
        let history = [];
        let historyIndex = -1;

        function saveState() {
            const snippets = [];
            for (let i = 1; i <= snippetCount; i++) {
                snippets.push({
                    snippet: document.getElementById(`snippet${i}`)?.value || '',
                    ref: document.getElementById(`ref${i}`)?.value || ''
                });
            }
            history = history.slice(0, historyIndex + 1);
            history.push({ snippets, snippetCount });
            historyIndex++;
        }

        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                restoreState();
            }
        }

        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                restoreState();
            }
        }

        function restoreState() {
            const state = history[historyIndex];
            snippetCount = state.snippetCount;
            const container = document.getElementById('snippets-container');
            container.innerHTML = '';
            state.snippets.forEach((item, i) => {
                const index = i + 1;
                const newSnippet = document.createElement('div');
                newSnippet.className = 'snippet';
                newSnippet.innerHTML = `
                    <h3>Text Snippet ${index}</h3>
                    <textarea id="snippet${index}" placeholder="Paste your text snippet here" spellcheck="true" aria-label="Text Snippet ${index}">${item.snippet}</textarea>
                    <span id="word-count${index}">Words: ${countWords(item.snippet)}</span>
                    <input type="text" id="ref${index}" placeholder="${getPlaceholder()}" value="${item.ref}" aria-label="Reference for Snippet ${index}">
                    <span id="error${index}" class="error"></span>
                `;
                container.appendChild(newSnippet);
            });
            updateAutoAdd();
            updatePreview();
            updateValidation();
        }

        function countWords(text) {
            return text.trim().split(/\s+/).filter(w => w.length > 0).length;
        }

        function addSnippet() {
            snippetCount++;
            const container = document.getElementById('snippets-container');
            const newSnippet = document.createElement('div');
            newSnippet.className = 'snippet';
            newSnippet.innerHTML = `
                <h3>Text Snippet ${snippetCount}</h3>
                <textarea id="snippet${snippetCount}" placeholder="Paste your text snippet here" spellcheck="true" aria-label="Text Snippet ${snippetCount}"></textarea>
                <span id="word-count${snippetCount}">Words: 0</span>
                <input type="text" id="ref${snippetCount}" placeholder="${getPlaceholder()}" aria-label="Reference for Snippet ${snippetCount}">
                <span id="error${snippetCount}" class="error"></span>
            `;
            container.appendChild(newSnippet);
            newSnippet.scrollIntoView({ behavior: 'smooth' });
            updateAutoAdd();
            saveState();
            updatePreview();
        }

        function updateAutoAdd() {
            const lastSnippet = document.getElementById(`snippet${snippetCount}`);
            lastSnippet.addEventListener('input', function() {
                if (lastSnippet.value.trim() !== '') {
                    addSnippet();
                }
            }, { once: true });
        }

        function getPlaceholder() {
            const style = document.getElementById('citationStyle').value;
            switch (style) {
                case 'apa': return 'e.g., Smith, J. (2020). Title. Journal.';
                case 'mla': return 'e.g., Smith, John. "Title." Journal, 2020.';
                case 'chicago': return 'e.g., Smith, John. 2020. "Title." Journal.';
                case 'harvard': return 'e.g., Smith, J., 2020. Title. Journal.';
                case 'ieee': return 'e.g., J. Smith, "Title," Journal, 2020.';
                case 'ama': return 'e.g., Smith J. Title. Journal. 2020.';
                case 'vancouver': return 'e.g., Smith J. Title. Journal 2020.';
                case 'turabian': return 'e.g., Smith, John. 2020. Title. Journal.';
                case 'oscola': return 'e.g., Smith J, "Title" (2020) Journal.';
                case 'bluebook': return 'e.g., John Smith, Title, Journal (2020).';
                default: return 'Reference';
            }
        }

        function validateReference(ref, style, index) {
            const patterns = {
                apa: /^[\w\s]+,\s*[\w\s]+\.\s*\(\d{4}\)\.\s*.+$/,
                mla: /^[\w\s]+,\s*[\w\s]+\.\s*".+"\.\s*.+,\s*\d{4}\.$/,
                chicago: /^[\w\s]+,\s*[\w\s]+\.\s*\d{4}\.\s*".+"\.\s*.+$/,
                harvard: /^[\w\s]+,\s*[\w\s]+,\s*\d{4}\.\s*.+\.\s*.+$/,
                ieee: /^[\w\s]+\.\s*".+",\s*.+,\s*\d{4}\.$/,
                ama: /^[\w\s]+\.\s*.+\.\s*.+\.\s*\d{4}\.$/,
                vancouver: /^[\w\s]+\.\s*.+\.\s*.+\s*\d{4}\.$/,
                turabian: /^[\w\s]+,\s*[\w\s]+\.\s*\d{4}\.\s*.+\.\s*.+$/,
                oscola: /^[\w\s]+\s*,\s*".+"\s*\(\d{4}\)\s*.+$/,
                bluebook: /^[\w\s]+,\s*.+,\s*.+\s*\(\d{4}\)\.$/
            };
            const errorSpan = document.getElementById(`error${index + 1}`);
            if (!ref || patterns[style].test(ref)) {
                errorSpan.style.display = 'none';
                return true;
            } else {
                errorSpan.innerText = `Incorrect citation for ${style.toUpperCase()} format.`;
                errorSpan.style.display = 'block';
                return false;
            }
        }

        function updateValidation() {
            for (let i = 1; i <= snippetCount; i++) {
                const ref = document.getElementById(`ref${i}`).value;
                validateReference(ref, document.getElementById('citationStyle').value, i - 1);
            }
        }

        function updatePlaceholders() {
            for (let i = 1; i <= snippetCount; i++) {
                const refInput = document.getElementById(`ref${i}`);
                if (refInput) refInput.placeholder = getPlaceholder();
                validateReference(refInput.value, document.getElementById('citationStyle').value, i - 1);
            }
            updatePreview();
        }

        function updatePreview() {
            const snippets = [];
            const references = [];
            for (let i = 1; i <= snippetCount; i++) {
                const snippet = document.getElementById(`snippet${i}`)?.value || '';
                const ref = document.getElementById(`ref${i}`)?.value || '';
                if (snippet && ref) {
                    snippets.push(snippet);
                    references.push(ref);
                }
            }
            const style = document.getElementById('citationStyle').value;
            const categorize = document.getElementById('categorize').checked;
            let combined = snippets.map((s, i) => `${s} (${references[i].split(",")[0]}, ${references[i].split(",")[1]})`).join("\n\n");
            if (categorize) {
                combined = categorizeSnippets(snippets, references);
            }
            const bibliography = generateBibliography(references, style);
            const outputText = combined + "\n\nBibliography:\n" + bibliography;
            document.getElementById('preview-content').innerText = outputText;
            updateWordCounts();
        }

        function categorizeSnippets(snippets, references) {
            // Placeholder for AI categorization
            const categories = [
                { name: "Methodology", snippets: [snippets[0]], refs: [references[0]] },
                { name: "Findings", snippets: snippets.slice(1), refs: references.slice(1) }
            ];
            return categories.map(cat => `${cat.name}:\n${cat.snippets.map((s, i) => `${s} (${cat.refs[i].split(",")[0]}, ${cat.refs[i].split(",")[1]})`).join("\n\n")}`).join("\n\n");
        }

        function combineText() {
            const snippets = [];
            const references = [];
            for (let i = 1; i <= snippetCount; i++) {
                const snippet = document.getElementById(`snippet${i}`).value;
                const ref = document.getElementById(`ref${i}`).value;
                if (snippet && ref) {
                    if (!validateReference(ref, document.getElementById('citationStyle').value, i - 1)) return;
                    snippets.push(snippet);
                    references.push(ref);
                }
            }
            const style = document.getElementById('citationStyle').value;
            const categorize = document.getElementById('categorize').checked;
            let combined = snippets.map((s, i) => `${s} (${references[i].split(",")[0]}, ${references[i].split(",")[1]})`).join("\n\n");
            if (categorize) {
                combined = categorizeSnippets(snippets, references);
            }
            const bibliography = generateBibliography(references, style);
            const outputText = combined + "\n\nBibliography:\n" + bibliography;
            document.getElementById('output-text').innerText = outputText;
            document.getElementById('output-modal').style.display = 'flex';
            updateWordCounts();
        }

        function generateBibliography(references, style) {
            let bib = "";
            references.forEach(ref => {
                const parts = ref.split(",").map(p => p.trim());
                if (parts.length < 2) return;
                switch (style) {
                    case "apa":
                        bib += `${parts[0]}. (${parts[1]}). ${parts[2] || "Untitled"}.\n`;
                        break;
                    case "mla":
                        bib += `${parts[0].split(" ").pop()}, ${parts[0].split(" ")[0]}. "${parts[2] || "Untitled"}." ${parts[1]}.\n`;
                        break;
                    default:
                        bib += `${parts[0]}, ${parts[1]}, ${parts[2] || "Untitled"}\n`;
                }
            });
            return bib;
        }

        function updateWordCounts() {
            for (let i = 1; i <= snippetCount; i++) {
                const snippet = document.getElementById(`snippet${i}`)?.value || '';
                const wordCountSpan = document.getElementById(`word-count${i}`);
                if (wordCountSpan) wordCountSpan.innerText = `Words: ${countWords(snippet)}`;
            }
            const outputText = document.getElementById('output-text').innerText;
            const snippetsOnly = outputText.split('\n\nBibliography:\n')[0].replace(/\([\w\s,]+\)/g, '');
            const totalWords = countWords(outputText);
            const snippetsWords = countWords(snippetsOnly);
            document.getElementById('word-count-output').innerText = `Total Words: ${totalWords} (Excluding Citations: ${snippetsWords})`;
        }

        function closeModal() {
            document.getElementById('output-modal').style.display = 'none';
            document.getElementById('save-online-options').style.display = 'none';
            document.getElementById('save-locally-options').style.display = 'none';
        }

        function copyText() {
            const text = document.getElementById('output-text').innerText;
            navigator.clipboard.writeText(text).then(() => {
                const message = document.getElementById('copy-message');
                message.style.display = 'inline';
                setTimeout(() => message.style.display = 'none', 2000);
            });
        }

        function savePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(document.getElementById('output-text').innerText, 10, 10);
            doc.save('research_synthesis.pdf');
        }

        function saveText() {
            const text = document.getElementById('output-text').innerText;
            const blob = new Blob([text], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'research_synthesis.txt';
            link.click();
        }

        function saveDocx() {
            const text = document.getElementById('output-text').innerText;
            const doc = new docxtemplater(new JSZip(), { paragraphLoop: true });
            const content = `
                <w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
                    <w:body>
                        <w:p><w:r><w:t>${text.replace(/\n/g, '</w:t></w:r></w:p><w:p><w:r><w:t>')}</w:t></w:r></w:p>
                    </w:body>
                </w:document>`;
            doc.loadZip(new JSZip()).setData(content).render();
            const blob = doc.getZip().generate({ type: 'blob' });
            saveAs(blob, 'research_synthesis.docx');
        }

        function saveMarkdown() {
            const text = document.getElementById('output-text').innerText;
            const markdown = text.replace(/^Bibliography:\n/, '## Bibliography\n');
            const blob = new Blob([markdown], { type: 'text/markdown' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'research_synthesis.md';
            link.click();
        }

        function saveRIS() {
            const references = [];
            for (let i = 1; i <= snippetCount; i++) {
                const ref = document.getElementById(`ref${i}`).value;
                if (ref) references.push(ref);
            }
            let ris = '';
            references.forEach(ref => {
                const parts = ref.split(",").map(p => p.trim());
                ris += `TY  - JOUR\nAU  - ${parts[0]}\nPY  - ${parts[1]}\nTI  - ${parts[2] || "Untitled"}\nER  -\n\n`;
            });
            const blob = new Blob([ris], { type: 'application/x-research-info-systems' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'research_synthesis.ris';
            link.click();
        }

        function saveToGoogleDrive() {
            alert('Google Drive integration requires API setup. Placeholder for now.');
        }

        function saveToDropbox() {
            alert('Dropbox integration requires API setup. Placeholder for now.');
        }

        function saveToOneDrive() {
            alert('OneDrive integration requires API setup. Placeholder for now.');
        }

        function toggleSaveOnline() {
            const options = document.getElementById('save-online-options');
            options.stylelift
            options.style.display = options.style.display === 'block' ? 'none' : 'block';
        }

        function toggleSaveLocally() {
            const options = document.getElementById('save-locally-options');
            options.style.display = options.style.display === 'block' ? 'none' : 'block';
        }

        function clearAll() {
            const container = document.getElementById('snippets-container');
            container.innerHTML = `
                <div class="snippet">
                    <h3>Text Snippet 1</h3>
                    <textarea id="snippet1" placeholder="Paste your first text snippet here" spellcheck="true" aria-label="Text Snippet 1"></textarea>
                    <span id="word-count1">Words: 0</span>
                    <input type="text" id="ref1" placeholder="${getPlaceholder()}" aria-label="Reference for Snippet 1">
                    <span id="error1" class="error"></span>
                </div>
                <div class="snippet">
                    <h3>Text Snippet 2</h3>
                    <textarea id="snippet2" placeholder="Paste your second text snippet here" spellcheck="true" aria-label="Text Snippet 2"></textarea>
                    <span id="word-count2">Words: 0</span>
                    <input type="text" id="ref2" placeholder="${getPlaceholder()}" aria-label="Reference for Snippet 2">
                    <span id="error2" class="error"></span>
                </div>
                <div class="snippet">
                    <h3>Text Snippet 3</h3>
                    <textarea id="snippet3" placeholder="Paste your third text snippet here" spellcheck="true" aria-label="Text Snippet 3"></textarea>
                    <span id="word-count3">Words: 0</span>
                    <input type="text" id="ref3" placeholder="${getPlaceholder()}" aria-label="Reference for Snippet 3">
                    <span id="error3" class="error"></span>
                </div>
            `;
            snippetCount = 3;
            updateAutoAdd();
            saveState();
            updatePreview();
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
        }

        document.getElementById('output-text').addEventListener('click', function(e) {
            if (e.detail === 1 && !window.getSelection().toString()) {
                const range = document.createRange();
                range.selectNodeContents(this);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'z') {
                e.preventDefault();
                undo();
            }
            if (e.ctrlKey && e.key === 'y') {
                e.preventDefault();
                redo();
            }
        });

        document.querySelectorAll('textarea, input').forEach(el => {
            el.addEventListener('input', () => {
                saveState();
                updatePreview();
                updateValidation();
            });
        });

        updateAutoAdd();
        saveState();
        updatePreview();
    </script>
</body>
</html>
