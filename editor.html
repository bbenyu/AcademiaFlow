<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Professional Editor</title>
    <link rel="stylesheet" href="styles.css">
    <script src="header.js"></script>
    <!-- TinyMCE CDN -->
    <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <style>
        .editor-container { margin-top: 24px; }
        #editor-status-bar { margin-top: 8px; font-size: 0.95em; display: flex; justify-content: space-between; align-items: center; }
        .tox-tinymce { border-radius: 6px; }
        .dark-mode .tox-tinymce { background: #222; color: #eee; }
        .center-viewport { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: var(--bg-color, #f4f4f4);}
        #spinner-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.7); z-index: 9999; display: none; align-items: center; justify-content: center;}
        .spinner { border: 6px solid #f3f3f3; border-top: 6px solid #007bff; border-radius: 50%; width: 48px; height: 48px; animation: spin 1s linear infinite;}
        @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
        button, .nav-links a, .nav-links button { transition: background 0.2s, transform 0.1s, box-shadow 0.2s;}
        button:hover, .nav-links a:hover, .nav-links button:hover { background: var(--primary-color, #007bff); color: #fff; transform: translateY(-2px) scale(1.04); box-shadow: 0 4px 16px rgba(0,123,255,0.08);}
        button:active, .nav-links a:active, .nav-links button:active { transform: scale(0.97);}
        .focus-mode .sidebar { display: none !important; }
        .focus-mode .main-content { width: 100vw !important; max-width: 100vw !important; }
        /* Sidebar consistency */
        .dashboard-sidebar, .sidebar {
            min-width: 220px;
            max-width: 260px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            margin: 32px 24px 32px 0;
            padding: 24px 12px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .sidebar-tools {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
        }
        .sidebar-tool-btn {
            background: var(--primary-color, #007bff);
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 8px 14px;
            font-size: 1em;
            text-align: left;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s, box-shadow 0.2s;
            box-shadow: 0 1px 4px rgba(0,123,255,0.04);
            width: 100%;
            text-decoration: none;
            display: block;
        }
        .sidebar-tool-btn:hover, .sidebar-tool-btn:focus {
            background: #0056b3;
            color: #fff;
            transform: translateY(-2px) scale(1.04);
            box-shadow: 0 4px 16px rgba(0,123,255,0.08);
        }
        
        /* Reference Library Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: #fff;
            border-radius: 10px;
            width: 80vw;
            max-width: 900px;
            height: 80vh;
            max-height: 700px;
            overflow-y: auto;
            position: relative;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
        }
        .dark-mode .modal-content {
            background: #222;
            color: #eee;
        }
        .close-modal {
            position: absolute;
            top: 12px;
            right: 18px;
            font-size: 1.5em;
            background: none;
            border: none;
            color: #333;
            cursor: pointer;
        }
        .dark-mode .close-modal {
            color: #eee;
        }
        #ref-list {
            margin-top: 16px;
            padding-left: 20px;
        }
        #ref-list li {
            margin-bottom: 8px;
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #ref-list li:hover {
            background: #f0f0f0;
        }
        .dark-mode #ref-list li:hover {
            background: #333;
        }
        .ref-controls {
            margin: 16px 0;
        }
        .ref-controls input, .ref-controls button {
            padding: 8px 12px;
            margin-right: 8px;
            border-radius: 4px;
        }
        .modal-content:focus { 
            outline: 2px solid #007bff; 
        }
        
        /* Plagiarism checker styles */
        #plagiarism-report {
            margin-top: 16px;
            padding: 12px;
            border-radius: 6px;
            background: #f8f9fa;
            display: none;
        }
        .dark-mode #plagiarism-report {
            background: #333;
        }
        .plagiarism-match {
            background-color: rgba(255, 0, 0, 0.2);
            border-bottom: 1px dashed red;
        }
        .plagiarism-progress {
            height: 6px;
            width: 100%;
            background-color: #e9ecef;
            border-radius: 3px;
            margin-bottom: 10px;
        }
        .plagiarism-progress-bar {
            height: 100%;
            background-color: #007bff;
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* Reference context menu styles */
        .context-menu {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 8px 0;
            z-index: 1000;
            display: none;
        }
        .dark-mode .context-menu {
            background: #333;
            border-color: #555;
        }
        .context-menu-item {
            padding: 8px 16px;
            cursor: pointer;
        }
        .context-menu-item:hover {
            background: #f0f0f0;
        }
        .dark-mode .context-menu-item:hover {
            background: #444;
        }
    </style>
</head>
<body>
    <div id="spinner-overlay"><div class="spinner"></div></div>
    <nav class="top-nav"></nav>
    
    <!-- Context Menu for References -->
    <div id="reference-context-menu" class="context-menu" role="menu">
        <div class="context-menu-item" id="insert-ref-here" tabindex="0">Insert Reference Here</div>
        <div class="context-menu-item" id="cite-ref-here" tabindex="0">Cite Reference</div>
        <div class="context-menu-item" id="add-to-library" tabindex="0">Add to Reference Library</div>
    </div>
    
    <!-- Reference Library Modal -->
    <div id="reference-modal" class="modal-overlay" tabindex="-1" aria-modal="true" role="dialog">
        <div class="modal-content">
            <button class="close-modal" onclick="closeReferenceLibrary()" aria-label="Close">&times;</button>
            <h3>Reference Library</h3>
            <div class="ref-controls">
                <input id="ref-input" placeholder="Add reference..." style="width:40%;">
                <input id="ref-tags" placeholder="Tags (comma separated)" style="width:30%;">
                <button onclick="addReferenceLib()">Add</button>
            </div>
            <div class="ref-controls">
                <input id="ref-search" placeholder="Search references..." style="width:70%;">
            </div>
            <ul id="ref-list"></ul>
        </div>
    </div>
    <div class="center-viewport">
        <div class="container" style="width: 100%; max-width: 1200px;">
        <aside class="dashboard-sidebar">
            <h2>Tools</h2>
            <div class="sidebar-tools">
                <a class="sidebar-tool-btn" href="index.html">Dashboard</a>
                <a class="sidebar-tool-btn" href="editor.html">Professional Editor</a>
                <a class="sidebar-tool-btn" href="#">Text & Reference Combiner</a>
                <a class="sidebar-tool-btn" href="#">Reference Library</a>
                <a class="sidebar-tool-btn" href="#">Plagiarism Checker</a>
                <a class="sidebar-tool-btn" href="#">Citation Generator</a>
                <a class="sidebar-tool-btn" href="#">Outline Builder</a>
            </div>
        </aside>
        <main class="main-content">
            <h2>Professional Editor</h2>
            <p>Advanced text editor with 50+ features to enhance your writing experience.</p>
            
            <div class="editor-actions" style="margin-bottom: 16px;">
                <button id="open-reference-library" title="Open Reference Library">üìö Reference Library</button>
                <button id="check-plagiarism" title="Check Plagiarism">üîç Check Plagiarism</button>
                <button id="insert-reference" title="Insert Reference">üìù Insert Reference</button>
            </div>
            
            <div class="editor-container">
                <textarea id="editor"></textarea>
                <div id="plagiarism-report">
                    <h3>Plagiarism Check Results</h3>
                    <div class="plagiarism-progress">
                        <div class="plagiarism-progress-bar"></div>
                    </div>
                    <div id="plagiarism-content"></div>
                </div>
                <div id="editor-status-bar">
                    <span id="word-count">Words: 0 | Characters: 0 | Reading Time: 0 min</span>
                    <div>
                        <button id="toggle-dark-mode" title="Toggle Dark Mode">üåô</button>
                        <button id="focus-mode-btn" title="Focus Mode">üñ•Ô∏è</button>
                        <button id="download-md-btn" title="Download as Markdown">MD</button>
                        <button id="clear-editor-btn" title="Clear Editor">üóëÔ∏è</button>
                        <button id="print-btn" title="Print">üñ®Ô∏è</button>
                    </div>
                </div>
            </div>
        </main>
        </div>
    </div>
    <script>
    // Context menu position variables
    let contextMenuPosition = { x: 0, y: 0 };
    
    // Initialize header
    renderHeader({
        title: "Editor",
        actions: [
            { label: "Dashboard", href: "index.html" }
        ]
    });

    // Spinner utility
    function showSpinner() { document.getElementById('spinner-overlay').style.display = 'flex'; }
    function hideSpinner() { document.getElementById('spinner-overlay').style.display = 'none'; }

    // Initialize TinyMCE with 50+ features
    tinymce.init({
        selector: '#editor',
        height: 500,
        plugins: [
            'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
            'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
            'insertdatetime', 'media', 'table', 'help', 'wordcount', 'emoticons',
            'codesample', 'directionality', 'nonbreaking', 'save', 'template',
            'pagebreak', 'quickbars', 'autoresize', 'print', 'hr', 'spellchecker'
        ],
        toolbar: [
            'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | forecolor backcolor | alignleft aligncenter alignright alignjustify | outdent indent | numlist bullist checklist |',
            'link image media codesample table hr pagebreak | anchor charmap emoticons | insertdatetime | searchreplace | visualblocks code fullscreen preview print | ltr rtl | save template |'
        ].join(' '),
        menubar: 'file edit view insert format tools table help',
        autosave_ask_before_unload: true,
        autosave_interval: '30s',
        autosave_prefix: '{path}{query}-{id}-',
        autosave_restore_when_empty: true,
        autosave_retention: '2m',
        image_advtab: true,
        image_title: true,
        quickbars_selection_toolbar: 'bold italic | quicklink h2 h3 blockquote quickimage quicktable',
        nonbreaking_force_tab: true,
        contextmenu: 'link image table spellchecker',
        spellchecker_dialog: true,
        spellchecker_whitelist: ['AcademiaFlow'],
        templates: [
            { title: 'Academic Paragraph', description: 'Standard paragraph', content: '<p>This is an academic paragraph template.</p>' },
            { title: 'Reference List', description: 'Reference section', content: '<h3>References</h3><ul><li>Author, A. (Year). Title. Journal.</li></ul>' }
        ],
        save_onsavecallback: function () {
            const user = localStorage.getItem('academictools_user') || 'default';
            localStorage.setItem('editor_' + user, tinymce.activeEditor.getContent());
            const statusBar = document.getElementById('editor-status-bar');
            const statusMsg = document.createElement('span');
            statusMsg.textContent = "Saved!";
            statusMsg.style.color = "green";
            statusBar.appendChild(statusMsg);
            setTimeout(() => statusMsg.remove(), 2000);
        },
        setup: function (editor) {
            // Word/char count and reading time
            function updateStatus() {
                const text = editor.getContent({ format: 'text' });
                const words = text.trim().split(/\s+/).filter(Boolean).length;
                const chars = text.replace(/\s/g, '').length;
                const readingTime = Math.max(1, Math.round(words / 200));
                document.getElementById('word-count').textContent = `Words: ${words} | Characters: ${chars} | Reading Time: ${readingTime} min`;
            }
            editor.on('keyup change', updateStatus);
            editor.on('init', function () {
                const user = localStorage.getItem('academictools_user') || 'default';
                const saved = localStorage.getItem('editor_' + user);
                if (saved) editor.setContent(saved);
                updateStatus();
            });
        }
    });
    
    // Dark Mode Toggle
    document.getElementById('toggle-dark-mode').onclick = function() {
        document.body.classList.toggle('dark-mode');
    };

    // Focus Mode
    document.getElementById('focus-mode-btn').onclick = function() {
        document.body.classList.toggle('focus-mode');
    };

    // Download as Markdown
    document.getElementById('download-md-btn').onclick = function() {
        const html = tinymce.activeEditor.getContent();
        // Simple HTML to Markdown conversion (for demo)
        let md = html.replace(/<h1>(.*?)<\/h1>/g, '# $1\n')
                     .replace(/<h2>(.*?)<\/h2>/g, '## $1\n')
                     .replace(/<h3>(.*?)<\/h3>/g, '### $1\n')
                     .replace(/<strong>(.*?)<\/strong>/g, '**$1**')
                     .replace(/<em>(.*?)<\/em>/g, '*$1*')
                     .replace(/<ul>/g, '').replace(/<\/ul>/g, '')
                     .replace(/<li>(.*?)<\/li>/g, '- $1\n')
                     .replace(/<br\s*\/?>/g, '\n')
                     .replace(/<[^>]+>/g, '');
        const blob = new Blob([md], { type: "text/markdown" });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "document.md";
        a.click();
        URL.revokeObjectURL(a.href);
    };

    // Clear Editor
    document.getElementById('clear-editor-btn').onclick = function() {
        if (confirm("Clear the editor?")) {
            tinymce.activeEditor.setContent('');
        }
    };

    // Print
    document.getElementById('print-btn').onclick = function() {
        tinymce.activeEditor.execCommand('mcePrint');
    };
    
    // Reference Library Functions
    function openReferenceLibrary() {
        document.getElementById('reference-modal').style.display = 'flex';
        renderRefList();
    }
    
    function closeReferenceLibrary() {
        document.getElementById('reference-modal').style.display = 'none';
    }
    
    function addReferenceLib() {
        const input = document.getElementById('ref-input');
        const tags = document.getElementById('ref-tags').value.split(',').map(t=>t.trim()).filter(Boolean);
        if (input.value.trim()) {
            const refs = JSON.parse(localStorage.getItem('ref_lib') || "[]");
            refs.push({text: input.value, tags});
            localStorage.setItem('ref_lib', JSON.stringify(refs));
            input.value = '';
            document.getElementById('ref-tags').value = '';
            renderRefList();
        }
    }
    
    function renderRefList() {
        const refs = JSON.parse(localStorage.getItem('ref_lib') || "[]");
        const search = document.getElementById('ref-search').value.toLowerCase();
        const ul = document.getElementById('ref-list');
        ul.innerHTML = "";
        
        refs.filter(r => r.text.toLowerCase().includes(search) || (r.tags && r.tags.join(',').toLowerCase().includes(search))).forEach((r, index) => {
            const li = document.createElement('li');
            li.innerHTML = `<span>${r.text}</span> <small>[${(r.tags||[]).join(', ')}]</small>
                <button onclick="insertReferenceToEditor('${r.text.replace(/'/g,"\\'")}')">Cite</button>
                <button onclick="copyReference('${r.text.replace(/'/g,"\\'")}')">Copy</button>
                <button onclick="editReference(${index})">Edit</button>
                <button onclick="deleteReference(${index})">Delete</button>`;
            ul.appendChild(li);
        });
    }
    
    function copyReference(ref) {
        navigator.clipboard.writeText(ref);
        alert("Copied to clipboard!");
    }
    
    function editReference(index) {
        const refs = JSON.parse(localStorage.getItem('ref_lib') || "[]");
        const newText = prompt("Edit reference:", refs[index].text);
        if (newText !== null) {
            refs[index].text = newText;
            localStorage.setItem('ref_lib', JSON.stringify(refs));
            renderRefList();
        }
    }
    
    function deleteReference(index) {
        const refs = JSON.parse(localStorage.getItem('ref_lib') || "[]");
        if (confirm("Delete this reference?")) {
            refs.splice(index, 1);
            localStorage.setItem('ref_lib', JSON.stringify(refs));
            renderRefList();
        }
    }
    
    function insertReferenceToEditor(reference) {
        tinymce.activeEditor.execCommand('mceInsertContent', false, reference);
        closeReferenceLibrary();
    }
    
    // Keyboard accessibility for modal
    document.getElementById('reference-modal').addEventListener('keydown', function(e) {
        if (e.key === "Escape") closeReferenceLibrary();
    });
    
    // Initialize reference library button
    document.getElementById('open-reference-library').onclick = openReferenceLibrary;
    
    // Initialize search functionality
    document.getElementById('ref-search').oninput = renderRefList;
    
    // Plagiarism checker functionality
    document.getElementById('check-plagiarism').onclick = function() {
        const content = tinymce.activeEditor.getContent({ format: 'text' });
        if (content.trim().length < 50) {
            alert("Please enter more text to check for plagiarism.");
            return;
        }
        
        showSpinner();
        const report = document.getElementById('plagiarism-report');
        const progressBar = document.querySelector('.plagiarism-progress-bar');
        const reportContent = document.getElementById('plagiarism-content');
        
        // Show the report area
        report.style.display = 'block';
        
        // Simulate plagiarism check with progress updates
        let progress = 0;
        const interval = setInterval(() => {
            progress += 5;
            progressBar.style.width = progress + '%';
            
            if (progress >= 100) {
                clearInterval(interval);
                hideSpinner();
                
                // Simulate finding some plagiarism (for demo purposes)
                const words = content.split(' ');
                const totalWords = words.length;
                const plagiarizedWords = Math.floor(Math.random() * 10); // Random number of "plagiarized" words
                const percentage = ((plagiarizedWords / totalWords) * 100).toFixed(1);
                
                reportContent.innerHTML = `
                    <p><strong>Analysis complete!</strong></p>
                    <p>Total words analyzed: ${totalWords}</p>
                    <p>Potential plagiarism detected: ${percentage}%</p>
                    <p>Highlighted ${plagiarizedWords} potentially plagiarized segments in your text.</p>
                `;
                
                // Highlight random words in the editor to simulate plagiarism detection
                const editor = tinymce.activeEditor;
                const editorContent = editor.getContent();
                let highlightedContent = editorContent;
                
                // Randomly highlight a few words (for demonstration)
                for (let i = 0; i < Math.min(5, plagiarizedWords); i++) {
                    const randomIndex = Math.floor(Math.random() * words.length);
                    if (words[randomIndex].length > 4) {
                        const regex = new RegExp(`\\b${words[randomIndex]}\\b`, 'g');
                        highlightedContent = highlightedContent.replace(
                            regex, 
                            `<span class="plagiarism-match">${words[randomIndex]}</span>`
                        );
                    }
                }
                
                editor.setContent(highlightedContent);
            }
        }, 100);
    };
    
    // Reference context menu functionality
    document.addEventListener('contextmenu', function(e) {
        // Only show context menu if we're in the editor
        if (tinymce.activeEditor && tinymce.activeEditor.getElement().contains(e.target)) {
            e.preventDefault();
            
            const contextMenu = document.getElementById('reference-context-menu');
            contextMenu.style.display = 'block';
            contextMenu.style.left = e.pageX + 'px';
            contextMenu.style.top = e.pageY + 'px';
            
            // Store position for later use
            contextMenuPosition.x = e.pageX;
            contextMenuPosition.y = e.pageY;
        }
    });
    
    // Hide context menu when clicking elsewhere
    document.addEventListener('click', function() {
        document.getElementById('reference-context-menu').style.display = 'none';
    });
    
    // Context menu actions
    document.getElementById('insert-ref-here').onclick = function() {
        openReferenceLibrary();
    };
    
    document.getElementById('cite-ref-here').onclick = function() {
        const selectedText = tinymce.activeEditor.selection.getContent({format: 'text'});
        if (selectedText) {
            // Format as citation (for demo purposes)
            const citation = `(${selectedText}, 2023)`;
            tinymce.activeEditor.selection.setContent(citation);
        } else {
            alert("Please select text to cite first");
        }
    };
    
    document.getElementById('add-to-library').onclick = function() {
        const selectedText = tinymce.activeEditor.selection.getContent({format: 'text'});
        if (selectedText) {
            const refs = JSON.parse(localStorage.getItem('ref_lib') || "[]");
            refs.push({text: selectedText, tags: []});
            localStorage.setItem('ref_lib', JSON.stringify(refs));
            alert("Added to reference library!");
        } else {
            alert("Please select text to add to library");
        }
    };
    
    // Insert reference button
    document.getElementById('insert-reference').onclick = function() {
        openReferenceLibrary();
    };
    </script>
</body>
</html>
